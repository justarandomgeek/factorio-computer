
`CPU Mk3.book.lua`: a Foreman Exported Book of all the logic modules required to build the CPU. Link matching colored signals as described below.  
`ScalarGen.blueprint.lua`: A Foreman Blueprint Script to generate the Scalar Pick/Insert mechanism for the current game's signal list.
`scalarmap.lua`: A machine descriptor file generated by ScalarGen.
`compiler.*`: A compiler (in C# and Lua) that transforms source files into blueprint strings for a strips of constant combinators configured as a ROM.


[![Image](http://static.justarandomgeek.com/factorio/screenshot+2016+07+15_800.png)  
(Click to embiggen)](http://static.justarandomgeek.com/factorio/screenshot+2016+07+15.png)  

## Machine Structure

#### Main Bus Signals

Major signals are labeled with floor concrete. Left side for green wire, right side for red wire. Power wires run on substations, signals wires run on poles.

| Pole Color | Red Wire | Green Wire |
|------------|----------|------------|
|Purple      | Memory Read Response | Memory Read Request
|Magenta     | Memory Write         |
|Blue        |                      | Scalar Result (`signal-grey`)
|Cyan        | Vector Result        | R2
|Green       | Scalars              | R1
|Yellow      | To PC                | Op
|Orange      | Status               | Op Pulse
|Hazard      | IO Wire | IO Wire
|FireHazard  | IO Wire Register | IO Wire Register

* Scalars
	* signal-grey: R1.s1
	* signal-white: R2.s2
* To PC
	* signal-blue: next
	* signal-green: rjmp to signal-black
	* signal-red: jump to signal-black

#### Machine Blocks


* White: PC update, Instruction Fetch & Decode
* White: IO Wire Port
* Black: NixieTerm
* Black: Registers
* Red: ALU
* Blue: Scalar Pick & Insert
* Purple: Memory Controller
* Purple: RAM
* Magenta: Flow Control
* Yellow+Hazard: Debug controls
* Hazard Border+Magenta: MemCopy

## Debug controls

* Auto-Step
	* Set `Yellow` in this combinator to enable automatic slow stepping through a program. Adjust timing in the `<` combinator.
* Step
	* Set and Clear `Yellow` in this combinator to run the cached PC update
* Hold
	* While `Yellow` is set in this combinator, PC update will be cached in the debug cirtuit and ignored by the PC update circuit. When cleared, the cached command is re-issued and program execution continues.
* Manual PC Command
	* Enter a PC update packet here, and Set and Clear `Yellow` to store it to the cache, or begin executing it immediately if not held.
* Clear Cached Command
	* Set Yellow here to clear the stored command.

## Registers

Registers store an entire circuit network frame, except `signal-black`. `signal-black` is used internally for various scalar and flag values throughout the machine, and cannot be stored in registers/memory, or expressed correctly in most mechanisms. All registers may be referred to by their number as `r0`,`r1`,`r2`,etc, and some registers may be referred to by name as listed in the table below.


| ID | Name | Purpose |
|----|------|---------|
|0|`rNull`|No Register selected|
|1-9|`r1`-`r9`| General Purpose data registers|
|10|`rRed`| IO Wire Red data since list transmitted|
|11|`rGreen`| IO Wire Green data since last transmitted|
|12|`rStat`| CPU Status register <ul><li>`signal-blue`: PC</li><li>`signal-green`: last call's return site</li></ul>|
|13|`rOp`| Current Op data|
|14|`rNixie`| NixieTerm|
|15,16|`r15`,`r16`| Wireless masts
|17+| `r17`-... | IO Expansion ports<br>Aditional devices may be connected to these registers <ul><li>Red wire: Read</li><li>Green wire: Write</li></ul>


## Operations
The following signals are used to select registers and signals:

|Signal  |Purpose|
|--------|-------|
|signal-0|Op|
|signal-A| Accumulate |
|signal-R|R1|
|signal-S|S1|
|signal-T|R2|
|signal-U|S2|
|signal-V|Rd|
|signal-W|Sd|
|signal-grey|R1.S1, Imm1 in ROM, Scalar Result|
|signal-white|R2.S2, Imm2 in ROM|

If Rd is set, the selected register will be cleared as Op Pulse is triggered unless Accumulate is also set (>0), even if the current operation does not actually assign to it. The whole register will be cleared, even in scalar operations.

#### 0: Halt
Any undefined opcode will halt the machine, but Op=0 is specifically reserved for doing so.

#### 1-60: ALU Operations
The ALU performs every possible operation in parallel, and returns the requested operation's result to Scalar Result or Vector Result.

|    |Comparisons|Arithmetic|
|----|-----------|----------|
|Output|<ul><li>0: Vector</li><li>24: Scalar</li></ul>|<ul><li>48: Vector</li><li>52: Scalar</li></ul></td>
|Operator|<ul><li>1:`=`</li><li>2:`<`</li><li>3:`>`</li></ul>|<ul><li>1:`-`</li><li>2:`+`</li><li>3:`/`</li><li>4:`*`</li></ul>
|Output Mode|<ul><li>0:`?=` Input Value</li><li>3:`?1` Flags</li></ul>||
|Input Mode|<ul><li>0: Every</li><li>6: Any</li><li>12: Scalar</li><li>18: Each</li></ul>|<ul><li>0: Each</li><li>4: Scalar</li></ul>

Add one value from each cell of a column to form an instruction.

#### 70-79 Control Flow
* 70: `jump`
* 71: `call`
* 72: `rjump`
* 73: `rcall`
* 74: `branch`
* 75: `branchcall`

`call` variants store a return site in the Green signal of the status register. For `call` and `rcall` this is PC+1, for `branchcall` it is PC+4.

`jump` and `call` execute the next instruction from the address R1.s1  
`rjump` and `rcall` execute the next instruction from the address PC+R1.s1  
`branch` and `branchcall` compare R1.s1 to R2.s2, and makes the following jumps:  

 * s1=s2 PC+1
 * s1<s2 PC+2
 * s1>s2 PC+3


#### 80: Wire
Write a packet to a two-wire network, and clear the receive registers for a response. To leave either wire untouched, select `rNull` for it. `rRed` and `rGreen` are cleared on the same frame the selected signals are transmitted. Write `rNull` to both wires to clear the receive buffer without transmitting anything.
* R1=>Red Wire
* R2=>Green Wire
* 0=>rRed,rGreen

#### 81: Write Memory
Write the contents of R1 to the memory location or memory-mapped device selected by R1.s1.
* R2 -> [R1.s1]

#### 82: Read Memory

* 82 : [R1.s1] -> Rd

## IO Devices

### NixieTerm

NixieTerm is a multi-line Alpha Nixie display. It can be accessed as an array of bit-packed strings in memory starting at `[500]`, or the lowermost row can be accessed as a `rNixie`, and shifted upward.

Any signals written in register mode will be added to the sum for the lowermost row. Writing `signal-grey` will shift all rows upward and clear the lower row. Color signals may be bit-packed along with characters.

A numeric value may also be written to a row on `signal-white` which will display in the left column of the corresponding display row.

NixieTerm supports all the characters supported by the Alpha Nixie:
* A-Z0-9 as their correspnding signals
* . as `train-stop`
* \- as `fast-splitter`

### Wireless

A cluster of wireless masts are connected on `r15` and `r16`. `r15` reads the current values on the wireless. `r16` is a memory cell which is connected to transmit to the wireless. There are 12 masts connected, by default configured to relay all virtual signals except `signal-black`, leaving 16 slots available for custom configuration. Additional masts may be wired in as needed.
